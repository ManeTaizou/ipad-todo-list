<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ToDoリスト</title>
  <style>
    :root{
      --bg:#f4f5f7; --card:#fff; --ink:#172b4d; --muted:#6b778c;
      --border:#dfe1e6; --checked:#9ca3af; --radius:8px;
      --gap:6px; --pad-card:10px; --input-h:26px; --head-h:24px;
      --head-gap:6px; --row-gap:6px; --list-gap:2px; --header-h:40px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Sans",sans-serif;
      font-size:14px; line-height:1.2; -webkit-text-size-adjust:100%;
    }
    header{
      background:var(--card); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      display:flex; justify-content:space-between; align-items:center;
      padding:6px 10px; height:var(--header-h);
    }
    h1{font-size:16px;font-weight:600}
    .controls{display:flex; gap:4px; align-items:center}
    .controls button,.controls label{
      border:1px solid var(--border); background:var(--card); color:var(--ink);
      padding:2px 8px; border-radius:6px; font-size:12px; cursor:pointer; height:26px;
    }

    /* ← ここが重要：dvh優先 + vhフォールバック。safe-areaも考慮 */
    .canvas{
      height:calc(100vh - var(--header-h));            /* fallback */
      height:calc(100dvh - var(--header-h));           /* modern iPadOS/Safari */
      padding:6px 6px calc(6px + env(safe-area-inset-bottom)) 6px;
      display:grid; grid-template-rows: 1fr 1fr; gap:var(--row-gap);
      -webkit-overflow-scrolling:touch;
    }

    .top{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); min-height:0; }
    .weekgrid{ display:grid; grid-template-columns:repeat(7,1fr); gap:var(--gap); min-height:0; }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:var(--pad-card); display:flex; flex-direction:column; min-height:0; overflow:hidden;
    }
    .card h2,.card h3{
      color:var(--muted); font-weight:600; line-height:1;
      margin:0 0 var(--head-gap) 0; height:var(--head-h); display:flex; align-items:center;
    }
    .card h2{font-size:13px}
    .card h3{font-size:12px}

    .list{
      flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:var(--list-gap); overflow:auto;
    }
    .item{ display:flex; align-items:center; gap:6px; height:var(--input-h); flex:0 0 auto; }
    .item input[type="checkbox"]{ width:16px; height:16px; margin:0; flex:0 0 auto; }
    .item input.text{
      width:100%; border:none; border-bottom:1px solid var(--border);
      background:transparent; padding:2px 2px; font-size:14px; font-family:inherit; height:100%;
    }
    .item.checked input.text{ text-decoration:line-through; color:var(--checked); }

    @media (orientation:landscape) and (min-width:1024px){
      :root{ --gap:6px; --pad-card:10px; --input-h:26px; --head-h:24px; --head-gap:6px; --list-gap:2px; }
      body{ font-size:14px }
    }
  </style>
</head>
<body>
  <header>
    <h1>ToDoリスト</h1>
    <div class="controls">
      <button id="clearChecks">全チェック解除</button>
      <button id="resetAll">すべてリセット</button>
      <button id="exportData">バックアップ</button>
      <label for="importDataInput">読み込み</label>
      <input id="importDataInput" type="file" accept="application/json" style="display:none">
    </div>
  </header>

  <div class="canvas" id="canvasRoot">
    <div class="top" id="topRow">
      <div class="card" id="month"><h2>今月やること</h2><div class="list" data-section="month"></div></div>
      <div class="card" id="week"><h2>今週やること</h2><div class="list" data-section="week"></div></div>
    </div>
    <div class="weekgrid" id="bottomRow">
      <div class="card"><h3>月曜日</h3><div class="list" data-section="月曜日"></div></div>
      <div class="card"><h3>火曜日</h3><div class="list" data-section="火曜日"></div></div>
      <div class="card"><h3>水曜日</h3><div class="list" data-section="水曜日"></div></div>
      <div class="card"><h3>木曜日</h3><div class="list" data-section="木曜日"></div></div>
      <div class="card"><h3>金曜日</h3><div class="list" data-section="金曜日"></div></div>
      <div class="card"><h3>土曜日</h3><div class="list" data-section="土曜日"></div></div>
      <div class="card"><h3>日曜日</h3><div class="list" data-section="日曜日"></div></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY='ipad-todo';
    const days=["月曜日","火曜日","水曜日","木曜日","金曜日","土曜日","日曜日"];
    const initial={ month:Array.from({length:10},()=>({checked:false,text:""})),
                    week:Array.from({length:10},()=>({checked:false,text:""})) };
    days.forEach(d=>initial[d]=Array.from({length:10},()=>({checked:false,text:""})));

    function normalizeToTen(arr){ const c=Array.isArray(arr)?arr.slice(0,10):[]; while(c.length<10)c.push({checked:false,text:""}); return c; }
    let state; try{ const saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
      state=saved?{
        month:normalizeToTen(saved.month), week:normalizeToTen(saved.week),
        ...Object.fromEntries(days.map(d=>[d,normalizeToTen(saved[d])]))
      }:JSON.parse(JSON.stringify(initial));
    }catch{ state=JSON.parse(JSON.stringify(initial)); }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function createItem(section,i){
      const it=state[section][i];
      const div=document.createElement('div'); div.className='item'+(it.checked?' checked':'');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=it.checked;
      const input=document.createElement('input'); input.type='text'; input.className='text'; input.value=it.text;
      cb.onchange=()=>{it.checked=cb.checked;div.classList.toggle('checked',cb.checked);save();};
      input.oninput=()=>{it.text=input.value;save();};
      div.append(cb,input); return div;
    }

    function render(){
      document.querySelectorAll('.list').forEach(list=>{
        const sec=list.dataset.section; list.innerHTML='';
        if(state[sec]){ for(let i=0;i<10;i++) list.append(createItem(sec,i)); }
      });
      requestAnimationFrame(reflowRows);
    }

    // ① カードの必要高さを実測して算出（見出し + リスト10行 + パディング/枠線/ギャップを含む）
    function neededCardHeight(card){
      const cs=getComputedStyle(card);
      const pad = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
      const border = parseFloat(cs.borderTopWidth) + parseFloat(cs.borderBottomWidth);

      const heading = card.querySelector('h2,h3');
      const hcs = getComputedStyle(heading);
      const headH = heading.getBoundingClientRect().height + parseFloat(hcs.marginBottom);

      const list = card.querySelector('.list');
      const lcs = getComputedStyle(list);
      const gap = parseFloat(lcs.rowGap) || 0;
      const firstItem=list.querySelector('.item');
      const itemH = firstItem ? firstItem.getBoundingClientRect().height : 26;

      const listNeed = (itemH * 10) + (gap * 9);

      return Math.ceil(pad + border + headH + listNeed);
    }

    // ② 上段=必要分ピッタリ / 下段=残り全部（不足時は曜日カード内がスクロール）
    function reflowRows(){
      const canvas=document.getElementById('canvasRoot');
      const topRow=document.getElementById('topRow');
      const bottomRow=document.getElementById('bottomRow');

      const canvasStyle=getComputedStyle(canvas);
      const padBlock = parseFloat(canvasStyle.paddingTop) + parseFloat(canvasStyle.paddingBottom);
      const rowGap = parseFloat(getComputedStyle(canvas).rowGap) || 0;

      // 利用可能高さ（トラック領域のみ）
      const available = canvas.clientHeight - padBlock - rowGap;

      // 上段必要高さ＝今月/今週のうち高い方
      const topCards = topRow.querySelectorAll('.card');
      const topNeed = Math.max(...Array.from(topCards, neededCardHeight));

      // 下段必要高さ（曜日カードは同寸想定。代表1枚でOK）
      const bottomCard = bottomRow.querySelector('.card');
      const bottomNeed = neededCardHeight(bottomCard);

      let topH, bottomH;
      if (topNeed + bottomNeed <= available) {
        // 余白は下段に集約（上段の下に隙間を作らない）
        topH = topNeed;
        bottomH = available - topH;
      } else {
        // はみ出すときは上段を優先的に確保
        topH = topNeed;
        bottomH = Math.max(0, available - topH);
      }

      canvas.style.gridTemplateRows = `${topH}px ${bottomH}px`;
    }

    // 操作系
    clearChecks.onclick=()=>{Object.keys(state).forEach(k=>state[k].forEach(i=>i.checked=false));save();render();};
    resetAll.onclick=()=>{if(confirm('リセットしますか？')){state=JSON.parse(JSON.stringify(initial));save();render();}};
    exportData.onclick=()=>{const b=new Blob([JSON.stringify(state)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='todo.json';a.click();};
    importDataInput.onchange=e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=()=>{try{
      const incoming=JSON.parse(r.result);
      state={month:normalizeToTen(incoming.month),week:normalizeToTen(incoming.week)};
      days.forEach(d=>state[d]=normalizeToTen(incoming[d])); save(); render();
    }catch{alert('読み込みに失敗しました');}}; r.readAsText(f);}};

    // 初期描画＋フォント読み込み後/回転/サイズ変更で再計測
    render();
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(()=>requestAnimationFrame(reflowRows)); }
    addEventListener('resize', ()=>requestAnimationFrame(reflowRows));
    addEventListener('orientationchange', ()=>requestAnimationFrame(reflowRows));
  </script>
</body>
</html>
